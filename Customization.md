# Customizations

The MRWA site supports two kinds of customizations:

- City customizations allow serving multiple cities from the same site on separate subdomains. Each city substitutes a set of strings and images to customize the site for that city. This is configured in `config/cities/<city-subdomain>.yml`.
- Brand customizations allow skinning the site to follow a particular "brand". The brand is the name of the site and language used in emails and other communications. Everything is still drain-related. The original brand is "Adopt-a-Drain", with an additional brand for "Storm Stewards" and the ability to add more in the future. Brands are configured in `config/brands/<brand-name>.yml`. Each city is configured to use a particular brand in its configuration file.

# City Customization

Here's how city customization works:

- Each city has a configuration file under `config/cities`. The name of the file is used as the id and subdomain of the city. Each city has its own logo generated by `generate-logos.ts`.
- Configuration files follow the `Schema` class in `app/helpers/city_helper.rb`.
- User and Thing models have a `city_domain` field that is set to the city's ID. **Note** that the Thing model also has a `city_id` field, which is the city's ID of the thing, not the city's subdomain.
- When a user accesses the site, the city is determined by the subdomain, and all Thing and User access is filtered by the `city_domain` field.
- When users sign up, their city is set based on the subdomain.
- Every piece of UI is generated from a template in `app/views`. The `CityHelper` module at `app/helpers/city_helper.rb` adds view helper methods that are used in the templates. Specifically, it adds a `c` method that allows looking up strings for the current city. This is similar to the i18n `t` method that looks up strings in the locale files.

The last point is the most important. The `c` method is used everywhere in the templates to look up strings. For example, here's how the `app/views/main/index.html.haml` template configures the logo in the sidebar:

```haml
.container-fluid{:class => (signed_in? ? "signed-in" : nil)}
  .row
    .sidebar
      .navbar.navbar-default
        %a{href: root_url}
          = image_tag c("site.logo"), :alt => t("titles.main", :thing => t("defaults.thing").titleize, :city => c("city.name")), :title => t("titles.main", :thing => t("defaults.thing").titleize, :city => c("city.name"))
```

`c("site.logo")` corresponds to the `site.logo` field of the `<city>.yml` file.

Note that all methods in the CityHelper are accessible from templates, but mainly just the `c` one is used.

# Branding Customization

Branding customization is an extension of city customization. There are a limited number of brands, and each has its own configuration file and schema. City configuration specifies the brand to use, and that brand's configuration is merged into the city configuration under the `brand` key. Templates can then use the `c` method to refer to the brand configuration.

(**TODO**) Branding can also swap out entire templates. This is implemented by updating Ruby views to render a different template depending on the current city's brand.

(**TODO**) Finally, branding values can point to other keys within the configuration file by prefixing the brand value with `c:`. This allows branding to swap out portions of templates while still supporting variation in cities.

Design discussion: https://chat.openai.com/share/7089070a-ac8f-46c0-b4ed-f6a4aa65935c

# Implementation

- Find a hard-coded string that needs to vary by city or brand.
- Identify an existing key in the configuration you can use to populate the string, or add a key to the `Schema` class and every city/brand configuration file.
- Use the `c` method in the template to look up the string.